import {
  to = segment_reverse_etl_model.id-8ad5iy71X1X9vYwYPZbsNC
  id = "8ad5iy71X1X9vYwYPZbsNC"
}

resource "segment_reverse_etl_model" "id-8ad5iy71X1X9vYwYPZbsNC" {
  description             = "Programatically generated rETL model that is associated with an Engage rETL audience"
  enabled                 = true
  name                    = "Linked Audience rETL Model"
  query                   = "WITH ID_GRAPH AS (\n\tSELECT \n\t\t\"CANONICAL_SEGMENT_ID\", \n\t\t\"SEGMENT_ID\"\n\tFROM \"SISING_SANDBOX\".\"SEGMENT_PROFILE_SYNC\".\"PROFILE_MERGES\"\n), EXTERNAL_ID_MAPPING AS (\n\tSELECT\n\t\tids.\"CANONICAL_SEGMENT_ID\" as \"CANONICAL_SEGMENT_ID\", \n\t\t\"TYPE\" as \"EXTERNAL_ID_TYPE\",\n\t\t\"VALUE\" as \"EXTERNAL_ID_VALUE\"\n\tFROM \"SISING_SANDBOX\".\"SEGMENT_PROFILE_SYNC\".\"USER_IDENTIFIERS\" AS ids\n\tINNER JOIN ID_GRAPH AS ig\n\t\tON ig.\"CANONICAL_SEGMENT_ID\" = ids.\"CANONICAL_SEGMENT_ID\"\n\tWHERE \"TYPE\" IN ('android.idfa','email','ios.idfa','user_id')\n), PROFILE_TRAITS AS (\n\tSELECT \n\t\tsids.\"CANONICAL_SEGMENT_ID\" AS \"CANONICAL_SEGMENT_ID\",\n\t\tMAX(tra.\"role\") AS \"role\"\n\tFROM EXTERNAL_ID_MAPPING sids\n\tLEFT JOIN (\n\t\tSELECT \n\t\t\ttraits.\"CANONICAL_SEGMENT_ID\" AS \"CANONICAL_SEGMENT_ID\",\n\t\t\tCASE WHEN \"NAME\" = 'role' THEN traits.\"VALUE\" END AS \"role\"\n\t\tFROM \"SISING_SANDBOX\".\"SEGMENT_PROFILE_SYNC\".\"USER_TRAITS\" AS traits\n\t\tWHERE FALSE \n\t\t\t OR (traits.\"NAME\" = 'role' AND traits.\"VALUE\" IS NOT NULL)\n\t) tra\n\tON sids.\"CANONICAL_SEGMENT_ID\" = tra.\"CANONICAL_SEGMENT_ID\"\n\tWHERE sids.\"EXTERNAL_ID_TYPE\" IN ('android.idfa','email','ios.idfa','user_id')\n\tGROUP BY sids.\"CANONICAL_SEGMENT_ID\"\n), ECG_1 AS (\n\tWITH filtered_query AS (\n\t\tSELECT A.\"CANONICAL_SEGMENT_ID\" AS \"A_CANONICAL_SEGMENT_ID\", B.\"USER_ID\" AS \"B_USER_ID\", C.\"ACCOUNT_ID\" AS \"C_ACCOUNT_ID\"\n\t\tFROM \"SISING_SANDBOX\".\"LINKED_WORKSHOP_SIMRAN\".\"WORKSPACE\" C\n\t\tINNER JOIN \"SISING_SANDBOX\".\"LINKED_WORKSHOP_SIMRAN\".\"ACCOUNT\" B ON B.\"ID\" = C.\"ACCOUNT_ID\"\n\t\tINNER JOIN EXTERNAL_ID_MAPPING A ON A.\"EXTERNAL_ID_TYPE\" = 'user_id' AND A.\"EXTERNAL_ID_VALUE\" = CAST(B.\"USER_ID\" AS VARCHAR)\n\t\tWHERE (((B.\"ACCOUNT_HEALTH\" IS NOT DISTINCT FROM 'RED')) AND (C.\"PLAN_RENEWAL\" BETWEEN CURRENT_TIMESTAMP AND (CURRENT_TIMESTAMP + INTERVAL '31536000 SECOND')))\n\t)\n\tSELECT * FROM filtered_query\n), ECG_1_SEGMENT_ID AS (\n\tSELECT \"A_CANONICAL_SEGMENT_ID\" AS \"CANONICAL_SEGMENT_ID\" FROM ECG_1 GROUP BY \"A_CANONICAL_SEGMENT_ID\"\n), PROFILE_FILTER AS (\n\tSELECT \"CANONICAL_SEGMENT_ID\" FROM PROFILE_TRAITS PT\n\tWHERE ((\"CANONICAL_SEGMENT_ID\" IN (SELECT \"CANONICAL_SEGMENT_ID\" FROM ECG_1_SEGMENT_ID)) and ((PT.\"role\" IS NOT DISTINCT FROM 'C-Level')))\n), ECG_1_FILTERED AS (\n\tSELECT * FROM ECG_1 ECG INNER JOIN PROFILE_FILTER PF ON ECG.\"A_CANONICAL_SEGMENT_ID\" = PF.\"CANONICAL_SEGMENT_ID\"\n)\nSELECT DISTINCT * FROM (\n\tSELECT \"CANONICAL_SEGMENT_ID\" as \"MATCHID\", \"CANONICAL_SEGMENT_ID\"\n\tFROM PROFILE_FILTER\n\tUNION ALL\n\tSELECT \"A_CANONICAL_SEGMENT_ID\" || ':' ||  '2' || ':' || REPLACE(CAST(\"B_USER_ID\" AS VARCHAR), ':', '::') || ':' || REPLACE(CAST(\"C_ACCOUNT_ID\" AS VARCHAR), ':', '::') as \"MATCHID\", \"A_CANONICAL_SEGMENT_ID\" as CANONICAL_SEGMENT_ID\n\tFROM ECG_1_FILTERED WHERE \"C_ACCOUNT_ID\" IS NOT NULL\n\tUNION ALL\n\tSELECT \"A_CANONICAL_SEGMENT_ID\" || ':' ||  '1' || ':' || REPLACE(CAST(\"B_USER_ID\" AS VARCHAR), ':', '::') as \"MATCHID\", \"A_CANONICAL_SEGMENT_ID\" as CANONICAL_SEGMENT_ID\n\tFROM ECG_1_FILTERED WHERE \"B_USER_ID\" IS NOT NULL\n) AS DEDUPED_PROJECTIONS"
  query_identifier_column = "matchId"
  source_id               = "toMuunXPwvbTgDRsvF5a3"
}